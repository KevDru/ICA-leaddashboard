@if (lead(); as l) {
<div class="lead-detail">
  <h2>Lead bewerken</h2>

  <form [formGroup]="form" (ngSubmit)="save()">
    <label>Titel *</label>
    <input formControlName="title"/>
    <label>Klant</label>
    <input formControlName="customer"/>
    <label>Contactpersoon</label>
    <input formControlName="contact_name" />
    <label>Email contact</label>
    <input formControlName="contact_email" />
    <label>Telefoon contact</label>
    <input formControlName="contact_phone" />
    <label>Beschrijving</label>
    <textarea formControlName="description"></textarea>
    <label>Aangemaakt op</label>
    <input type="datetime-local" formControlName="created_at" />
    <button type="submit" [disabled]="!form.valid">Opslaan</button>
    <button type="button" class="delete-btn" (click)="delete()">Lead verwijderen</button>
  </form>
  

  <h3 (click)="toggleNotes()" class="collapsible-header">
    <span class="toggle">{{ notesExpanded() ? 'â–¼' : 'â–¶' }}</span>
    Notities
  </h3>
  @if (notesExpanded()) {
    <div class="notes-section">
      <form [formGroup]="noteForm" class="note-form">
        <textarea formControlName="content" placeholder="Voeg een notitie toe..." (keydown)="onNoteTextareaKeydown($event)"></textarea>
  <button type="button" (click)="addNote()" [disabled]="!noteForm.valid">Notitie toevoegen</button>

      </form>
      <ul>
        @for (n of notes(); track n.id) {
          <li class="note-item" id="note-{{ n.id }}" attr.data-note-id="{{ n.id }}">
            <div class="note-content">{{ n.content }}</div>
            <div class="note-meta">
              @if (n.author_name) {
                <span class="author">door {{ n.author_name }}</span>
              }
              <span class="date">{{ n.created_at | date: 'short' }}</span>
            </div>
            <button type="button" class="delete-btn" (click)="deleteNote(n.id)">Ã—</button>
          </li>
        }
        @empty {
          <li class="empty">Nog geen notities</li>
        }
      </ul>
    </div>
  }

  <h3 (click)="toggleAttachments()" class="collapsible-header">
    <span class="toggle">{{ attachmentsExpanded() ? 'â–¼' : 'â–¶' }}</span>
    Bijlagen
  </h3>
  @if (attachmentsExpanded()) {
    <div class="attachments-section">
      <input type="file" (change)="onFileSelected($event)" />
      @if (uploadError()) {
        <p class="error">{{ uploadError() }}</p>
      }
      <ul>
        @for (a of attachments(); track a.id) {
          <li class="attachment-item" id="attachment-{{ a.id }}" attr.data-attachment-id="{{ a.id }}">
            <span class="name" (click)="downloadAttachment(a)">ðŸ“„ {{ a.file_name }}</span>
            @if (a.uploader_name) {
              <span class="uploader">door {{ a.uploader_name }}</span>
            }
            <button type="button" class="delete-btn" (click)="deleteAttachment(a.id)">Ã—</button>
          </li>
        }
        @empty {
          <li>Geen bijlagen</li>
        }
      </ul>
    </div>
  }

  <h3 (click)="toggleHistory()" class="collapsible-header">
    <span class="toggle">{{ historyExpanded() ? 'â–¼' : 'â–¶' }}</span>
    Geschiedenis
  </h3>
  @if (historyExpanded()) {
    <ul class="history-list">
      @for (h of history(); track h.id) {
        <li class="history-item" (click)="onHistoryClick(h)" [class.clickable]="isHistoryClickable(h)" [attr.title]="isHistoryClickable(h) ? 'Klik om item te openen' : null">
          <div class="action">{{ h.action }}</div>
          @if (h.user_name) { <span class="user">door {{ h.user_name }}</span> }
          <span class="time"> op {{ h.created_at }}</span>
        </li>
      }
      @empty {
        <li>Geen geschiedenis beschikbaar</li>
      }
    </ul>
  }
</div>
}

